{% extends "layouts/main.html" %}

{% block title %}Tableau de bord - Système de Gestion de Matériel{% endblock %}

{% block head_extra %}
<style>
    /* Styles spécifiques au tableau de bord */
    .materials-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .material-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .material-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .material-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-bottom: 1px solid #eee;
    }
    
    .material-info {
        padding: 15px;
    }
    
    .material-name {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--dark-color);
    }
    
    .material-type {
        display: inline-block;
        padding: 3px 8px;
        background: var(--primary-color);
        color: white;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-bottom: 10px;
    }
    
    .material-description {
        color: #666;
        margin-bottom: 10px;
    }
    
    .material-availability {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
    }
    
    .available-tag {
        font-weight: bold;
    }
    
    .low-stock {
        color: var(--danger-color);
    }
    
    .view-mode-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .view-btn {
        padding: 5px 10px;
        background: #eee;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .view-btn.active {
        background: var(--primary-color);
        color: white;
    }
    
    .hidden {
        display: none;
    }
    
    /* Barre de progression pour la disponibilité */
    .availability-bar {
        height: 8px;
        background: #eee;
        border-radius: 4px;
        margin-top: 5px;
        overflow: hidden;
    }
    
    .availability-progress {
        height: 100%;
        background: var(--primary-color);
    }
    
    .low-availability .availability-progress {
        background: var(--danger-color);
    }

    /* Classes de largeur pré-définies pour les barres de progression */
    .w-5 { width: 5%; }
    .w-10 { width: 10%; }
    .w-15 { width: 15%; }
    .w-20 { width: 20%; }
    .w-25 { width: 25%; }
    .w-30 { width: 30%; }
    .w-35 { width: 35%; }
    .w-40 { width: 40%; }
    .w-45 { width: 45%; }
    .w-50 { width: 50%; }
    .w-55 { width: 55%; }
    .w-60 { width: 60%; }
    .w-65 { width: 65%; }
    .w-70 { width: 70%; }
    .w-75 { width: 75%; }
    .w-80 { width: 80%; }
    .w-85 { width: 85%; }
    .w-90 { width: 90%; }
    .w-95 { width: 95%; }
    .w-100 { width: 100%; }
</style>
{% endblock %}

{% block content %}
<section class="dashboard">
    <h1>Tableau de bord</h1>
    
    <div class="stats">
        <div class="stat-card">
            <h3>Matériels totaux</h3>
            <p class="stat-number">{{ total_materials }}</p>
        </div>
        
        <div class="stat-card">
            <h3>Types</h3>
            <p class="stat-number">2</p>
        </div>
        
        <div class="stat-card">
            <h3>Disponibilité</h3>
            <p class="stat-number">
                {% set available = 0 %}
                {% for material in materials %}
                    {% set available = available + material.available %}
                {% endfor %}
                {{ available }} / {{ total_materials }}
            </p>
        </div>
    </div>
    
    <h2>Liste des matériels</h2>
    
    <div class="filters">
        <button class="filter-btn active" data-filter="all">Tous</button>
        <button class="filter-btn" data-filter="desktop">Ordinateurs de bureau</button>
        <button class="filter-btn" data-filter="laptop">Ordinateurs portables</button>
    </div>
    
    <div class="view-mode-buttons">
        <button class="view-btn active" data-view="grid">Vue grille</button>
        <button class="view-btn" data-view="table">Vue tableau</button>
    </div>
    
    <!-- Vue Grille (avec images) -->
    <div class="materials-grid" id="grid-view">
        {% for material in materials %}
        {% set pct = (material.available / material.total * 100)|round|int %}
        <div class="material-card" data-type="{{ material.type }}">
            {% if material.image_path is defined %}
                <img src="{{ material.image_path }}" alt="{{ material.name }}" class="material-image">
            {% else %}
                <img src="https://placehold.co/400x300?text={{ material.name|replace(' ', '+') }}" alt="{{ material.name }}" class="material-image">
            {% endif %}
            <div class="material-info">
                <div class="material-name">{{ material.name }}</div>
                <div class="material-type">{{ 'Bureau' if material.type == 'desktop' else 'Portable' }}</div>
                <div class="material-description">{{ material.description }}</div>
                
                <div class="material-availability">
                    <span>Disponibilité:</span>
                    <span class="available-tag {% if material.available / material.total < 0.2 %}low-stock{% endif %}">
                        {{ material.available }} / {{ material.total }}
                    </span>
                </div>
                
                <div class="availability-bar {% if material.available / material.total < 0.2 %}low-availability{% endif %}">
                    <div class="availability-progress w-{{ pct }}"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Vue Tableau (originale) -->
    <table id="materials-table" class="hidden">
        <thead>
            <tr>
                <th>Image</th>
                <th>Nom</th>
                <th>Type</th>
                <th>Disponible</th>
                <th>Total</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            {% for material in materials %}
            <tr data-type="{{ material.type }}">
                <td>
                    {% if material.image_path is defined %}
                        <img src="{{ material.image_path }}" alt="{{ material.name }}" style="width: 50px; height: 50px; object-fit: cover;">
                    {% else %}
                        <img src="https://placehold.co/400x300?text={{ material.name|replace(' ', '+') }}" alt="{{ material.name }}" style="width: 50px; height: 50px; object-fit: cover;">
                    {% endif %}
                </td>
                <td>{{ material.name }}</td>
                <td>{{ 'Bureau' if material.type == 'desktop' else 'Portable' }}</td>
                <td class="{% if material.available / material.total < 0.2 %}low-stock{% endif %}">{{ material.available }}</td>
                <td>{{ material.total }}</td>
                <td>{{ material.description }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion des filtres
        const filterButtons = document.querySelectorAll('.filter-btn');
        const materialCards = document.querySelectorAll('.material-card');
        const tableRows = document.querySelectorAll('#materials-table tbody tr');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Retirer la classe active de tous les boutons
                filterButtons.forEach(btn => btn.classList.remove('active'));
                
                // Ajouter la classe active au bouton cliqué
                this.classList.add('active');
                
                // Filtrer les cartes et le tableau
                const filterValue = this.getAttribute('data-filter');
                
                // Filtrer les cartes
                materialCards.forEach(card => {
                    if (filterValue === 'all') {
                        card.style.display = '';
                    } else {
                        const cardType = card.getAttribute('data-type');
                        if (cardType === filterValue) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    }
                });
                
                // Filtrer le tableau
                tableRows.forEach(row => {
                    if (filterValue === 'all') {
                        row.style.display = '';
                    } else {
                        const rowType = row.getAttribute('data-type');
                        if (rowType === filterValue) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            });
        });
        
        // Gestion des vues (grille ou tableau)
        const viewButtons = document.querySelectorAll('.view-btn');
        const gridView = document.getElementById('grid-view');
        const tableView = document.getElementById('materials-table');
        
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Retirer la classe active de tous les boutons
                viewButtons.forEach(btn => btn.classList.remove('active'));
                
                // Ajouter la classe active au bouton cliqué
                this.classList.add('active');
                
                // Afficher la vue correspondante
                const viewType = this.getAttribute('data-view');
                
                if (viewType === 'grid') {
                    gridView.classList.remove('hidden');
                    tableView.classList.add('hidden');
                } else {
                    gridView.classList.add('hidden');
                    tableView.classList.remove('hidden');
                }
            });
        });
    });
</script>
{% endblock %}
